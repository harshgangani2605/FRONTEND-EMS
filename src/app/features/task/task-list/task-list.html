<div class="department-container">

  <!-- Header -->
  <div class="header-row">
    <h2>Tasks</h2>

    <div class="header-actions">
      <input
        type="text"
        class="search-input"
        placeholder="Search tasks..."
        [(ngModel)]="search"
        (input)="searchTasks()" />

      <button
        class="add-btn"
        (click)="goToCreate()"
        *hasPermission="'task.create'">
        + Add Task
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading" *ngIf="loading">
    Loading tasks...
  </div>

  <!-- Table -->
  <div class="table-wrapper" *ngIf="!loading">
    <table class="department-table">

      <thead>
        <tr>
          <th>#</th>
          <th>Project</th>
          <th>Title</th>
          <th>Assigned To</th>
          <th>Priority</th>
          <th>Status</th>
          <th>Due Date</th>
          <th *ngIf="isAdmin">Created By</th>
          <th class="actions-header" *ngIf="hasAnyActionPermission()">Actions</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let t of tasks; let i = index">

          <td>{{ (page - 1) * pageSize + i + 1 }}</td>
          <td>{{ t.projectName || '—' }}</td>
          <td>{{ t.title }}</td>
          <td>{{ t.assignedToName || '—' }}</td>
          <td>{{ t.priority | titlecase }}</td>

          <!-- STATUS -->
          <td>
            <span
              class="status-badge"
              [ngClass]="{
                'pending': t.status === 'Pending',
                'completed': t.status === 'Completed'
              }">
              {{ t.status }}
            </span>
          </td>

          <td>{{ t.dueDate | date:'dd-MM-yyyy' }}</td>

          <!-- ADMIN ONLY -->
          <td *ngIf="isAdmin">{{ t.createdBy }}</td>

          <!-- ACTIONS -->
          <td class="action-buttons" *ngIf="hasAnyActionPermission()">

            <!-- VIEW -->
            <button
              class="icon-btn view"
              title="View Task"
              (click)="goToView(t.id)">
              <i class="bi bi-eye"></i>
            </button>

            <!-- EDIT -->
            <button
              class="icon-btn edit"
              title="Edit Task"
              (click)="goToEdit(t.id)"
              *hasPermission="'task.edit'">
              <i class="bi bi-pencil"></i>
            </button>

            <!-- DELETE -->
            <button
              class="icon-btn delete"
              title="Delete Task"
              (click)="delete(t.id)"
              *hasPermission="'task.delete'">
              <i class="bi bi-trash"></i>
            </button>

            <!-- COMPLETE -->
            <button
              class="icon-btn success"
              title="Mark Completed"
              *ngIf="t.status !== 'Completed'"
              (click)="changeStatus(t.id, 'Completed')">
              <i class="bi bi-check2-circle"></i>
            </button>

          </td>

        </tr>
      </tbody>

    </table>

    <!-- No Data -->
    <p class="no-data" *ngIf="tasks.length === 0">
      No tasks found
    </p>
  </div>

  <!-- Pagination -->
  <div class="pagination">
    <button
      [disabled]="page === 1"
      (click)="prevPage()">
      Prev
    </button>

    <span>
      Page {{ page }} of {{ totalPages }}
    </span>

    <button
      [disabled]="(page * pageSize) >= totalCount"
      (click)="nextPage()">
      Next
    </button>
  </div>

</div>
